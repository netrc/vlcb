extends layout

block pagecontent
  div.row
    div.span2
      b.pageHead Churches
    div.span3
      form.form-inline(method="post")
        input.input-small(type="text",name="rn",placeholder="search")
        button.btn(type="submit") Search
    div.span3
      div.btn-group(data-toggle="buttons-radio")
        button#cSortAlpha.btn.sorter(type="button") A-Z
        button#cSortShire.btn.sorter(type="button") Shire
        button#cSortYear.btn.sorter(type="button") Year
    div.span4
      form.form-inline(method="post")
        input.input-small(type="text",name="cn",placeholder="Church Name")
        input.input-small(type="text",name="ca",placeholder="Address")
        button.btn(type="submit"): i.icon-plus-sign

  div.row
    div.span6
      ul#churchList.nav.nav-pills.nav-stacked
    div.span6
      div#churchShow.well.fixMe
        div#churchShowTitle
          span#churchShowName
          span#churchShowAddress
        div#churchShowPics
        div#churchShowInfo
          <i> year: </i>
          span#churchShowYear
          <i> latlon: </i>
          span#churchShowLatlon
        div#churchShowBrasses
        div#churchShowMainNote

block pagescript
  script
    $(document).ready(function() {
      $.get("/rest/Church/","",function(d,tstatus,jxhr) {
        //alert("c2b: got churches: "+d.length);
        for (var i=0;i<d.length;i++) { 
            c = d[i];
            cButtId = "cButtId"+i;
            cButtIdRef = "#"+cButtId;
            newLi  = "<li> <button id=\""+cButtId+"\"> "+c.name+"<i> - "+c.address+"</i></button></li>\n";
            $("#churchList").append(newLi);
            $(cButtIdRef).on( 'click', (function(zc) { return function(){churchShow(zc); } })(c) );
        };
        if (d.length>0) {
            churchShow( d[0] );
        };
      } );
    });

    var churchUrl = function ( c, s ) {
        return("/rest/Church/" + c.name + "/" + s);
    }
    var churchShow = function ( c ) {
        //alert("new cshow: "+c.name);

        //$("#churchShowTitle").html("<b>" + c.name + "</b> <i> - " + c.address + "</i>");
        $("#churchShowName").html("<b>" + c.name + "</b>");
        $("#churchShowAddress").html("<i> - " + c.address + "</i>");
        $("#churchShowPics").html("<i> no pics yet </i> <p>");
        $("#churchShowYear").html(c.year);
        $("#churchShowLatlon").html(c.latlon);
        $("#churchShowBrasses").html("<i> no brasses found </i> <p>");
        $("#churchShowMainNote").html( "<i> no note yet </i>" );

        $.get(churchUrl(c,"Pic"),"",function(d,tstatus,jxhr) {
            if (d.length==0) {
                return;
            };
            pStr = "";
            for (var i=0;i<d.length;i++) { 
                p = d[i];
                pStr = pStr + "<img src=\"" + p.thumb + "\"> <p>";
            };
            $("#churchShowPics").html( pStr  );
        } );
        $.get(churchUrl(c,"mainNote"),{tFormat:'HTML'},function(d,tstatus,jxhr) {
            //alert(" c mn get html");
            $('#churchShowMainNote').html(d);
        } );
        $.get(churchUrl(c,"Brass"),"",function(d,tstatus,jxhr) {
            //alert("cbr length: " + d.length);
            if (d.length==0) {
                return;
            };
            bStr = "";
            for (var i=0;i<d.length;i++) { 
                b = d[i];
                bStr = bStr + " <a href=\"//brass/\">" + b.name + "</a>" + (((i+1)<d.length) ? ", " : "");
            };
            $("#churchShowBrasses").html( bStr );
        } );

        $("#churchShowLatlon").editable(churchUrl(c,"latlon"), {
         type      : 'text',
         cancel    : 'Cancel',
         submit    : 'OK',
         indicator : '<img src="favicon.ico">',
         style   : 'display: inline',
         tooltip   : 'Click to edit...'
        });
        $("#churchShowYear").editable(churchUrl(c,"year"), { 
         type      : 'text',
         cancel    : 'Cancel',
         submit    : 'OK',
         indicator : '<img src="favicon.ico">',
         style   : 'display: inline',
         tooltip   : 'Click to edit...'
        });
        $("#churchShowMainNote").editable(churchUrl(c,"mainNote"), { 
         type      : 'textarea',
         loadurl : churchUrl(c,"mainNote"),
         cancel    : 'Cancel',
         submit    : 'OK',
         indicator : '<img src="favicon.ico">',
         tooltip   : 'Click to edit...'
        });
    }